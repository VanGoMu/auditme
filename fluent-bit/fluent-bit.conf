[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    ${LOG_LEVEL}
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

# INPUT: System logs (journald) - Errors and warnings
[INPUT]
    Name                systemd
    Tag                 system.journal
    Path                /var/log/journal
    Systemd_Filter      PRIORITY=0
    Systemd_Filter      PRIORITY=1
    Systemd_Filter      PRIORITY=2
    Systemd_Filter      PRIORITY=3
    Systemd_Filter      PRIORITY=4
    Systemd_Filter_Type Or
    Read_From_Tail      On
    Strip_Underscores   On
    Lowercase           On

# INPUT: Boot logs
[INPUT]
    Name                systemd
    Tag                 system.boot
    Path                /var/log/journal
    Systemd_Filter      _TRANSPORT=kernel
    Read_From_Tail      On
    Strip_Underscores   On
    Lowercase           On

[FILTER]
    Name                record_modifier
    Match               *
    Record hostname     ${HOSTNAME}
    Record environment  production

# FILTER: Add month-based bucket routing
[FILTER]
    Name                lua
    Match               *
    script              /fluent-bit/etc/bucket_router.lua
    call                add_monthly_bucket

# OUTPUT: Send to InfluxDB v2 (system logs)
[OUTPUT]
    Name                influxdb
    Match               system.*
    Host                influxdb
    Port                8086
    Org                 ${INFLUX_ORG}
    Bucket              system_logs
    HTTP_Token          ${INFLUX_TOKEN}
    Tag_Keys            systemd_unit hostname month_bucket
    Sequence_Tag        _seq
